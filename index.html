<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Camera Test</title>
    <style>
    canvas, video{
        border: 1px solid gray;
    }
    </style>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
    <!-- Load Posenet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <script>
        var CANVAS_CAMERA = Null;
        var EFFECTS_CAMERA = Null;
        const SIZE = 400;
        const INTERVAL = 42;

        function main() {
            CANVAS_CAMERA = document.getElementById('camera');
            CANVAS_CAMERA.width = SIZE;
            CANVAS_CAMERA.height = SIZE;
            CANVAS_CAMERA = document.getElementById('effects');
            CANVAS_CAMERA.width = SIZE;
            CANVAS_CAMERA.height = SIZE;
            /** カメラ設定 */
            const constraints = {
                audio: false,
                video: {
                width: 500,
                height: 400,
                facingMode: "user"   // フロントカメラを利用する
                //facingMode: { exact: "environment" }  // リアカメラを利用する場合
                }
            };
            /**
             * カメラを<video>と同期
             */
            const permission = navigator.mediaDevices.getUserMedia(constraints);
            permission.then(
                function(stream) {
                    const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    setInterval(updateImage, INTERVAL, video);
            })
            .catch( 
                function(err) {
                alert(err.name + ": " + err.message);
            });
        }
        
        function updateImage(video){
            const context = CANVAS_CAMERA.getContext('2d');
            context.drawImage(video, 0, 0, SIZE, SIZE)
        }
    </script>
</head>
  <body onload = "main()">

    <h1>HTML5カメラ</h1>
    <canvas id = "camera"></canvas>
    <canvas id = "effects"></canvas>
    <!--<video id="camera" autoplay playsinline></video>
    <canvas id="picture" width="300" height="200"></canvas>
    <form>
      <button type="button" id="shutter">シャッター</button>
    </form>
    -->
    
    <script>

    window.onload = () => {
      const video  = document.querySelector("#camera");
      const canvas = document.querySelector("#picture");
    
      /** カメラ設定 */
      const constraints = {
        audio: false,
        video: {
          width: 500,
          height: 400,
          facingMode: "user"   // フロントカメラを利用する
          //facingMode: { exact: "environment" }  // リアカメラを利用する場合
        }
      };
    
      /**
       * カメラを<video>と同期
       */
      navigator.mediaDevices.getUserMedia(constraints)
      .then( (stream) => {
        video.srcObject = stream;
        video.onloadedmetadata = (e) => {
          video.play();
        };
      })
      .catch( (err) => {
        console.log(err.name + ": " + err.message);
      });
    
      /**
       * シャッターボタン
       */
       document.querySelector("#shutter").addEventListener("click", () => {
        const ctx = canvas.getContext("2d");
    
        // 演出的な目的で一度映像を止めてSEを再生する
        video.pause();  // 映像を停止
        setTimeout( () => {
          video.play();    // 0.5秒後にカメラ再開
        }, 500);
    
        // canvasに画像を貼り付ける
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        var flipHorizontal = false;

        var imageElement = document.getElementById('picture');

        posenet.load().then(function(net) {
        const pose = net.estimateSinglePose(imageElement, {
            flipHorizontal: true
        });
        return pose;
        }).then(function(pose){
        console.log(pose);
        })
    });
    };
    </script>
    
<!-- <img id='cat' src='./images/cat.jpg '/> -->
  </body>
</html>