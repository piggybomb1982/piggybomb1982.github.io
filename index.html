<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Camera Test</title>
    <style type="text/css">
        /* インカメで左右反転 */
        #camera, #canvas{
            margin:0;
            padding:0;
            border:0;
            font:inherit;
            font-size:100%;
            vertical-align:baseline;
            transform: rotateY(180deg);
            -webkit-transform:rotateY(180deg);
            -moz-transform:rotateY(180deg);
        }
    </style>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
    <!-- Load Posenet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <script>
        var CAMERA = null;
        var CANVAS = null;
        const WSIZE = window.innerWidth;
        const HSIZE = window.innerHeight;
        const INTERVAL = 42;
        var COLOR = [4, 104, 39];

        function main() {
            CAMERA = document.getElementById('camera');
            CAMERA.width = WSIZE;
            CAMERA.height = HSIZE;
            CANVAS = document.getElementById('canvas');
            CANVAS.width = WSIZE;
            CANVAS.height = HSIZE;
            var element_box = document.getElementById('canvas');

            /** カメラ設定 */
            const constraints = {
                audio: false,
                video: {
                    width: WSIZE,
                    height: HSIZE,
                    facingMode: "user"   // フロントカメラを利用する
                //facingMode: { exact: "environment" }  // リアカメラを利用する場合
                }
            };
            /**
             * カメラを<video>と同期
             */
            const permission = navigator.mediaDevices.getUserMedia(constraints);
            permission.then(
                function(stream) {
                    const video  = document.querySelector("#camera");
                    //const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    setInterval(updateImage, INTERVAL, video);
            })
            .catch( 
                function(err) {
                alert(err.name + ": " + err.message);
            });
        }
        
        function updateImage(video){
            const context = CANVAS.getContext('2d');
            context.drawImage(video,0 , 0, WSIZE, HSIZE, 0,0,WSIZE, HSIZE);
        }

        function getDuration() {
            //動画の長さ（秒）を表示
            document.getElementById("nagasa").innerHTML = CAMERA.duration;
        }

        function playVideo() {
            //再生完了の表示をクリア
            document.getElementById("kanryou").innerHTML = "";
            //動画を再生
            CAMERA.play();
            //現在の再生位置（秒）を表示
            CAMERA.addEventListener("timeupdate", function(){
                document.getElementById("ichi").innerHTML = CAMERA.currentTime;
            }, false);
            //再生完了を知らせる
            CAMERA.addEventListener("ended", function(){
                document.getElementById("kanryou").innerHTML = "動画の再生が完了しました。";
            }, false);
        }

        function pauseVideo() {
            //動画を一時停止
            CAMERA.pause();
        }

        function upVolume() {
            //音量を上げる
            CAMERA.volume = CAMERA.volume + 0.25;
        }

        function downVolume() {
            //音量を下げる
            CAMERA.volume = CAMERA.volume - 0.25;
        }
    </script>
</head>
<body onload="main()">
    <video id="camera" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <!--    <div style="width:400px; background-color:#333333; color:#ffffff;">
        <input type="button" value="再生" onClick="playVideo()">
        <input type="button" value="一時停止" onClick="pauseVideo()">
        <input type="button" value="↑" onClick="upVolume()">
        <input type="button" value="↓" onClick="downVolume()"><br>
        現在（秒）：<span id="ichi">0</span><br>
        全体（秒）：<span id="nagasa"></span><br>
        <span id="kanryou"></span>
    </div>

    <div class="parent">
        <div class="l1">
            <video id="camera" autoplay playsinline></video>
        </div>
        <div class="l2">
            <canvas id="canvas"></canvas>
        </div>
        <div class="l3">
            <a id="start_btn" href="#" class="start_btn">Start</a>
        </div>
    </div>
    <script src="./js/index.js"></script>
    <video id="camera" autoplay playsinline></video>
    <canvas id="picture" width="300" height="200"></canvas>
    <form>
      <button type="button" id="shutter">シャッター</button>
    </form>

    
    <script>

    window.onload = () => {
      const video  = document.querySelector("#camera");
      const canvas = document.querySelector("#picture");
    
      /** カメラ設定 */
      const constraints = {
        audio: false,
        video: {
          width: 500,
          height: 400,
          facingMode: "user"   // フロントカメラを利用する
          //facingMode: { exact: "environment" }  // リアカメラを利用する場合
        }
      };
    
      /**
       * カメラを<video>と同期
       */
      navigator.mediaDevices.getUserMedia(constraints)
      .then( (stream) => {
        video.srcObject = stream;
        video.onloadedmetadata = (e) => {
          video.play();
        };
      })
      .catch( (err) => {
        console.log(err.name + ": " + err.message);
      });
    
      /**
       * シャッターボタン
       */
       document.querySelector("#shutter").addEventListener("click", () => {
        const ctx = canvas.getContext("2d");
    
        // 演出的な目的で一度映像を止めてSEを再生する
        video.pause();  // 映像を停止
        setTimeout( () => {
          video.play();    // 0.5秒後にカメラ再開
        }, 500);
    
        // canvasに画像を貼り付ける
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        var flipHorizontal = false;

        var imageElement = document.getElementById('picture');

        posenet.load().then(function(net) {
        const pose = net.estimateSinglePose(imageElement, {
            flipHorizontal: true
        });
        return pose;
        }).then(function(pose){
        console.log(pose);
        })
    });
    };
    </script>
    
<img id='cat' src='./images/cat.jpg '/> -->
  </body>
</html>