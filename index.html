<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Camera Test</title>
    <style>
    canvas, video{
        border: 1px solid gray;
    }
    </style>

    <style type="text/css">
        .parent {
            width: 720px;
            height: 0px;
            position: relative; /*relativeに設定*/
            border: 3px solid black;
            padding: 0em 0em;
            margin:0;
        }
        .l1 { /*前回の話の通り、動画ストリームが確定してから自動的にサイズが決まる*/
            top: 0px;
            left: 0px;
            width: 720px; 
            padding: 0em 0em;
        }
        .l2 {
            top: 0px;   /*動的に変更されるので適当*/
            left: 0px;  /*動的に変更されるので適当*/
            width: 400px; /*撮影枠サイズ*/ 
            height: 60px; /*撮影枠サイズ*/
            position: absolute; /*absoluteに設定*/
            padding: 0em 0em;
        }
        .l3 {
            top: 0px;   /*動的に変更されるので適当*/
            left: 0px;  /*動的に変更されるので適当*/
            width: 400px; /*撮影枠サイズ*/ 
            height: 60px; /*撮影枠サイズ*/
            position: absolute; /*absoluteに設定*/
            padding: 0em 0em;
        }
        #canvas{
            position: absolute; /*absoluteに設定*/
            border: 1px solid red; /*赤い撮影枠*/
            padding: 0em 0em;
        }
    </style>
<script type="text/javascript">
    function notify_change_size() {
        video_layout_width  = video.clientWidth
        video_layout_height = video.clientHeight
    
        var element_parent = document.getElementsByClassName('parent');
        var element_l2  = document.getElementsByClassName('l2');
        var element_l3  = document.getElementsByClassName('l3');
        var element_box = document.getElementById('canvas');
    
        left = 0
        top = 0
    
        //parentへの設定
        for(var i=0, l=element_parent.length; i<l; i++){
            element_parent[i].style.width   =  String(video_layout_width)  + "px";
            element_parent[i].style.height  =  String(video_layout_height) + "px";
        }
    
        //l2への設定
        for(var i=0, l=element_l2.length; i<l; i++){
            //今回はi=0のみ
            element_l2[i].style.left =  String(left)  + "px";
            element_l2[i].style.top  =  String(top)   + "px";
            element_l2[i].style.width   =  String(video_layout_width)  + "px";
            element_l2[i].style.height  =  String(video_layout_height) + "px";
        }

        //l3への設定
        for(var i=0, l=element_l3.length; i<l; i++){
            //今回はi=0のみ
            element_l2[i].style.left =  String(left)  + "px";
            element_l2[i].style.top  =  String(video_layout_height)   + "px";
            element_l2[i].style.width   =  String(video_layout_width)  + "px";
        }
    
        //camera_record_boxへの設定
        element_box.setAttribute("width",  String(video_layout_width)  + "px");
        element_box.setAttribute("height", String(video_layout_height) + "px");
    }
    
    videoElement.onresize = notify_change_size;
    
    </script>
    <!-- Load TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
    <!-- Load Posenet -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
    <script>
        var CANVAS_CAMERA = null;
        var EFFECTS_CAMERA = null;
        // const SIZE = 400;
        const INTERVAL = 42;
        var COLOR = [4, 104, 39];

        function main() {
            CAMERA = document.getElementById('camera');
            //CAMERA.width = SIZE;
            //CAMERA.height = SIZE;
            CANVAS = document.getElementById('canvas');
            //CANVAS.width = SIZE;
            //CANVAS.height = SIZE;
            /** カメラ設定 */
            const constraints = {
                audio: false,
                video: {
                // width: 500,
                // height: 400,
                //flipHorizontal: ture,
                facingMode: "user"   // フロントカメラを利用する
                //facingMode: { exact: "environment" }  // リアカメラを利用する場合
                }
            };
            /**
             * カメラを<video>と同期
             */
            const permission = navigator.mediaDevices.getUserMedia(constraints);
            permission.then(
                function(stream) {
                    const video  = document.querySelector("#camera");
                    //const video = document.createElement('video');
                    video.srcObject = stream;
                    video.play();
                    setInterval(updateImage, INTERVAL, video);
            })
            .catch( 
                function(err) {
                alert(err.name + ": " + err.message);
            });
        }
        
        function updateImage(video){
            const context = CANVAS.getContext('2d');
            context.drawImage(video,0 , 0);
        }

    </script>
</head>
<body onload="main()">
    <div class="parent" width="720px">
        <div class="l1">
            <video id="camera" width="720px" autoplay playsinline></video>
        </div>
        <div class="l2">
            <canvas id="canvas"></canvas>
        </div>
        <div class="l3">
            <a id="start_btn" href="#" class="start_btn">Start</a>
        </div>
    </div>
    <!--<script src="./js/index.js"></script>
    <video id="camera" autoplay playsinline></video>
    <canvas id="picture" width="300" height="200"></canvas>
    <form>
      <button type="button" id="shutter">シャッター</button>
    </form>

    
    <script>

    window.onload = () => {
      const video  = document.querySelector("#camera");
      const canvas = document.querySelector("#picture");
    
      /** カメラ設定 */
      const constraints = {
        audio: false,
        video: {
          width: 500,
          height: 400,
          facingMode: "user"   // フロントカメラを利用する
          //facingMode: { exact: "environment" }  // リアカメラを利用する場合
        }
      };
    
      /**
       * カメラを<video>と同期
       */
      navigator.mediaDevices.getUserMedia(constraints)
      .then( (stream) => {
        video.srcObject = stream;
        video.onloadedmetadata = (e) => {
          video.play();
        };
      })
      .catch( (err) => {
        console.log(err.name + ": " + err.message);
      });
    
      /**
       * シャッターボタン
       */
       document.querySelector("#shutter").addEventListener("click", () => {
        const ctx = canvas.getContext("2d");
    
        // 演出的な目的で一度映像を止めてSEを再生する
        video.pause();  // 映像を停止
        setTimeout( () => {
          video.play();    // 0.5秒後にカメラ再開
        }, 500);
    
        // canvasに画像を貼り付ける
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        var flipHorizontal = false;

        var imageElement = document.getElementById('picture');

        posenet.load().then(function(net) {
        const pose = net.estimateSinglePose(imageElement, {
            flipHorizontal: true
        });
        return pose;
        }).then(function(pose){
        console.log(pose);
        })
    });
    };
    </script>
    
<img id='cat' src='./images/cat.jpg '/> -->
  </body>
</html>